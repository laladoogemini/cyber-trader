<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <!-- é—œéµä¿®æ­£ï¼šåŠ å…¥ viewport è¨­å®šï¼Œè®“æ‰‹æ©Ÿæ­£ç¢ºç¸®æ”¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Intelligent Market Analytics</title>
    
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- å¼•å…¥ Google Fonts (Inter) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            /* å°ˆæ¥­é‡‘èé…è‰² */
            --primary: #0f172a;      /* æ·±æµ·è»è— (Sidebar) */
            --accent: #2563eb;       /* äº®è—è‰² (æŒ‰éˆ•/é‡é») */
            --bg-body: #f1f5f9;      /* æ·ºç°èƒŒæ™¯ */
            --bg-card: #ffffff;      /* å¡ç‰‡ç™½åº• */
            --text-main: #1e293b;    /* ä¸»è¦æ–‡å­— */
            --text-muted: #64748b;   /* æ¬¡è¦æ–‡å­— */
            --border: #e2e8f0;       /* æŸ”å’Œé‚Šæ¡† */
            
            --success: #10b981;      /* æ¼² (ç¶ ) */
            --danger: #ef4444;       /* è·Œ (ç´…) */
            
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        /* å…¨å±€è¨­å®š */
        * {
            box-sizing: border-box; /* è®“å¯¬åº¦è¨ˆç®—åŒ…å« Paddingï¼Œé˜²æ­¢ç ´ç‰ˆ */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤æ‰‹æ©Ÿé»æ“Šè—æ¡† */
        }

        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            display: flex;
            height: 100vh;
            overflow: hidden; /* é›»è…¦ç‰ˆé–å®šè¦–çª—ï¼Œå…§éƒ¨æ²å‹• */
        }

        /* --- å´é‚Šæ¬„ --- */
        .sidebar {
            width: 280px;
            background-color: var(--primary);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 24px;
            box-shadow: 4px 0 24px rgba(0,0,0,0.05);
            z-index: 10;
            overflow-y: auto; /* å…§å®¹å¤šæ™‚å¯æ²å‹• */
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            flex-shrink: 0;
        }
        .logo i { color: var(--accent); }

        .section-label {
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            margin-top: 20px;
        }

        /* è¼¸å…¥æ§ä»¶æ¨£å¼ */
        select, input {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 16px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: 0.2s;
            appearance: none; /* ç§»é™¤æ‰‹æ©ŸåŸç”Ÿæ¨£å¼ */
        }
        select option { background: var(--text-main); color: white; }
        input::placeholder { color: rgba(255,255,255,0.4); }
        input:focus, select:focus {
            border-color: var(--accent);
            background: rgba(255,255,255,0.15);
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--accent);
            color: white;
        }
        .btn-primary:hover { background-color: #1d4ed8; transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        
        .btn-secondary {
            background-color: rgba(255,255,255,0.1);
            color: white;
            margin-bottom: 20px;
        }
        .btn-secondary:hover { background-color: rgba(255,255,255,0.2); }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
        }
        .btn-outline:hover { background: #f8fafc; }

        /* --- ä¸»å…§å®¹å€ --- */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .top-bar {
            height: 64px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            flex-shrink: 0;
        }
        .top-title { font-weight: 600; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
            -webkit-overflow-scrolling: touch; /* iOS æ…£æ€§æ²å‹• */
        }

        /* --- å„€è¡¨æ¿å¡ç‰‡ --- */
        .hud-grid {
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 1000px;
        }

        .hud-card {
            background: var(--bg-card);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: transform 0.2s;
        }
        
        .hud-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            letter-spacing: 0.5px;
            display: block;
            margin-bottom: 8px;
        }
        .hud-val {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
        }

        /* --- åœ–è¡¨å€ --- */
        .chart-box {
            display: none;
            width: 100%;
            max-width: 1000px;
            height: 400px;
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
        }

        /* --- å ±å‘Šå€ --- */
        .report-box {
            display: none;
            width: 100%;
            max-width: 920px;
            background: var(--bg-card);
            padding: 48px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            position: relative;
        }

        .copy-btn {
            position: absolute;
            top: 24px;
            right: 24px;
            background: #f1f5f9;
            color: var(--text-muted);
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .copy-btn:hover { background: #e2e8f0; color: var(--text-main); }

        /* --- Markdown --- */
        .markdown-body { line-height: 1.8; color: #334155; overflow-wrap: break-word; }
        .markdown-body h1 { 
            font-size: 28px; 
            color: var(--text-main); 
            border-bottom: 2px solid var(--border); 
            padding-bottom: 16px; 
            margin-top: 0; 
        }
        .markdown-body h2 { 
            font-size: 20px; 
            color: var(--primary); 
            margin-top: 32px; 
            margin-bottom: 16px;
            display: flex;
            align-items: center;
        }
        .markdown-body h2::before {
            content: '';
            display: inline-block;
            width: 6px;
            height: 24px;
            background-color: var(--accent);
            margin-right: 12px;
            border-radius: 4px;
        }
        .markdown-body strong { color: var(--text-main); font-weight: 700; }
        .markdown-body ul { padding-left: 20px; margin-bottom: 20px; }
        .markdown-body li { margin-bottom: 8px; }
        .markdown-body p { margin-bottom: 16px; }

        /* --- Loading --- */
        .loader {
            display: none;
            text-align: center;
            padding: 40px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(37, 99, 235, 0.1);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 0.8s ease-in-out infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .loader h3 { margin: 0; color: var(--text-main); font-size: 16px; }
        .loader p { color: var(--text-muted); font-size: 14px; margin-top: 8px; }

        /* --- Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(2px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-box {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 32px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            text-align: left;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            margin-top: 0;
            color: var(--text-main);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .modal-title i { color: var(--accent); }

        /* ========================================= */
        /* ğŸ“± æ‰‹æ©Ÿç‰ˆ RWD æ ¸å¿ƒä»£ç¢¼ (Mobile CSS)     */
        /* ========================================= */
        @media (max-width: 768px) {
            /* 1. ä½ˆå±€æ”¹ç‚ºå‚ç›´å †ç–Š */
            body {
                flex-direction: column;
                height: auto;
                overflow-y: auto; /* å…è¨±æ•´é æ²å‹• */
            }

            /* 2. å´é‚Šæ¬„è®Šæˆé ‚éƒ¨æ§åˆ¶é¢æ¿ */
            .sidebar {
                width: 100%;
                height: auto;
                padding: 20px;
                box-shadow: none;
                border-bottom: 1px solid var(--border);
                flex-shrink: 0;
            }
            .logo { 
                margin-bottom: 20px; 
                justify-content: center; 
            }

            /* 3. èª¿æ•´ä¸»å…§å®¹å€ */
            .main {
                width: 100%;
                height: auto;
                overflow: visible;
            }
            .content {
                padding: 20px; /* ç¸®å°å…§è· */
            }

            /* 4. é ‚éƒ¨æ¨™é¡Œåˆ—èª¿æ•´ */
            .top-bar {
                padding: 0 20px;
                height: 56px;
            }
            .top-title {
                font-size: 15px;
            }

            /* 5. å„€è¡¨æ¿æ”¹ç‚º 2 æ¬„ (åŸæœ¬æ˜¯ 4 æ¬„æœƒå¤ªæ“ ) */
            .hud-grid {
                grid-template-columns: 1fr 1fr; 
                gap: 12px;
            }
            .hud-card {
                padding: 16px;
            }
            .hud-val {
                font-size: 20px;
            }

            /* 6. åœ–è¡¨é«˜åº¦èª¿æ•´ */
            .chart-box {
                height: 300px;
                padding: 16px;
            }

            /* 7. å ±å‘Šå€å¡Šèª¿æ•´ */
            .report-box {
                padding: 24px;
            }
            .markdown-body h1 {
                font-size: 24px;
            }
            
            /* 8. æ”¾å¤§é»æ“Šå€åŸŸ (å„ªåŒ–æ‰‹æŒ‡é«”é©—) */
            select, input, .btn {
                padding: 14px;
                font-size: 16px; /* é˜²æ­¢ iOS è¼¸å…¥æ™‚è‡ªå‹•æ”¾å¤§ */
            }
            
            /* 9. éš±è—ä¸å¿…è¦çš„åº•éƒ¨ç‰ˆè™Ÿ */
            .sidebar > div[style*="font-size:12px"] {
                display: none;
            }
        }
    </style>
</head>
<body>

<!-- å´é‚Šæ¬„ -->
<div class="sidebar">
    <div class="logo">
        <i class="fa-solid fa-chart-line"></i>
        <span>Alpha Analytics</span>
    </div>
    
    <div class="section-label">å¸‚å ´æ¦‚æ³ Market Overview</div>
    <button class="btn btn-secondary" onclick="run('WEEKLY')">
        <i class="fa-solid fa-globe"></i> ç”Ÿæˆå…¨æ™¯é€±å ± Macro Report
    </button>

    <div class="section-label">å€‹è‚¡ç ”ç©¶ Equity Research</div>
    <select id="sel" onchange="document.getElementById('inp').value=this.value">
        <option value="" disabled selected>å¿«é€Ÿé¸æ“‡ Quick Select</option>
        <optgroup label="ğŸ”¥ ç†±é–€å°è‚¡">
            <option value="2330">2330 å°ç©é›»</option>
            <option value="2317">2317 é´»æµ·</option>
            <option value="2603">2603 é•·æ¦®</option>
            <option value="0050">0050 å°ç£50</option>
        </optgroup>
        <optgroup label="ğŸ‡ºğŸ‡¸ ç¾è‚¡å·¨é ­">
            <option value="NVDA">NVDA è¼é”</option>
            <option value="TSLA">TSLA ç‰¹æ–¯æ‹‰</option>
            <option value="AAPL">AAPL è˜‹æœ</option>
            <option value="AMD">AMD è¶…å¾®</option>
        </optgroup>
        <optgroup label="ğŸª™ åŠ å¯†è²¨å¹£">
            <option value="BTC-USD">BTC æ¯”ç‰¹å¹£</option>
            <option value="ETH-USD">ETH ä»¥å¤ªå¹£</option>
        </optgroup>
    </select>
    
    <input type="text" id="inp" placeholder="è¼¸å…¥ä»£è™Ÿ Enter Ticker...">
    
    <button class="btn btn-primary" onclick="run('STOCK')">
        <i class="fa-solid fa-bolt"></i> é–‹å§‹åˆ†æ Start Analysis
    </button>

    <div style="flex:1"></div>
    <div style="font-size:12px; color:rgba(255,255,255,0.4);">v2.1 RWD Edition</div>
</div>

<!-- ä¸»å…§å®¹ -->
<div class="main">
    <div class="top-bar">
        <div class="top-title">æŠ•è³‡ç ”ç©¶å ±å‘Š Investment Report</div>
        <button class="btn btn-outline" style="width:auto; padding: 8px 16px;" onclick="runExplain()">
            <i class="fa-solid fa-language"></i> ç™½è©±è§£è®€ Explain
        </button>
    </div>

    <div class="content">
        <!-- è¼‰å…¥ä¸­ç‹€æ…‹ -->
        <div id="loader" class="loader">
            <div class="spinner"></div>
            <h3>æ­£åœ¨ç”Ÿæˆå ±å‘Š Generating Report...</h3>
            <p id="statusText">Connecting to Quantitative Models...</p>
        </div>

        <!-- æ•¸æ“šå„€è¡¨æ¿ (HUD) -->
        <div id="hud" class="hud-grid">
            <div class="hud-card">
                <span class="hud-label">ç¾åƒ¹ Price</span>
                <span id="h-price" class="hud-val">--</span>
            </div>
            <div class="hud-card">
                <span class="hud-label">æ¼²è·Œå¹… Change (%)</span>
                <span id="h-pct" class="hud-val">--</span>
            </div>
            <div class="hud-card">
                <span class="hud-label">ç›¸å°å¼·å¼± RSI (14)</span>
                <span id="h-rsi" class="hud-val">--</span>
            </div>
            <div class="hud-card">
                <span class="hud-label">æŠ€è¡“è¶¨å‹¢ Trend</span>
                <span id="h-trend" class="hud-val" style="font-size:18px;">--</span>
            </div>
        </div>

        <!-- åœ–è¡¨å€ -->
        <div id="chartBox" class="chart-box">
            <canvas id="priceChart"></canvas>
        </div>

        <!-- æ–‡å­—å ±å‘Šå€ -->
        <div id="reportBox" class="report-box">
            <button class="copy-btn" onclick="copyRaw()">
                <i class="fa-regular fa-copy"></i> è¤‡è£½ Copy
            </button>
            <div id="md-content" class="markdown-body"></div>
            <textarea id="rawText" style="display:none;"></textarea>
        </div>
    </div>
</div>

<!-- å½ˆçª— -->
<div id="modal" class="modal" onclick="this.style.display='none'">
    <div class="modal-box" onclick="event.stopPropagation()">
        <h3 class="modal-title"><i class="fa-solid fa-robot"></i> AI è§£è®€åŠ©æ‰‹ Assistant</h3>
        <p id="explainText" style="line-height:1.6; color:#475569; margin:20px 0;">...</p>
        <button class="btn btn-primary" onclick="document.getElementById('modal').style.display='none'">é—œé–‰ Close</button>
    </div>
</div>

<script>
let myChart = null;

async function run(type) {
    let ticker = type==='WEEKLY' ? 'WEEKLY' : document.getElementById('inp').value.trim();
    if(!ticker) return alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ / Please enter ticker");

    // UI Reset
    document.getElementById('hud').style.display = 'none';
    document.getElementById('chartBox').style.display = 'none';
    document.getElementById('reportBox').style.display = 'none';
    document.getElementById('loader').style.display = 'block';
    
    // æ‰‹æ©Ÿç‰ˆè‡ªå‹•æ²å‹•åˆ° loading
    if(window.innerWidth <= 768) {
        document.getElementById('loader').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    document.getElementById('statusText').innerText = type==='WEEKLY' 
        ? "æ­£åœ¨åˆ†æå®è§€ç¶“æ¿Ÿæ•¸æ“š / Analyzing Macro Data..." 
        : "æ­£åœ¨ç²å–å³æ™‚å¸‚å ´æ•¸æ“š / Fetching Real-time Data...";

    try {
        const res = await fetch('/get_analysis', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ticker: ticker})
        });
        const data = await res.json();
        
        document.getElementById('loader').style.display = 'none';

        if(data.error) {
            alert(data.error);
            return;
        }

        // å€‹è‚¡æ¨¡å¼ï¼šé¡¯ç¤º HUD èˆ‡ åœ–è¡¨
        if(data.type === 'stock') {
            const m = data.meta;
            document.getElementById('h-price').innerText = m.price;
            
            // æ¼²è·Œé¡è‰²è™•ç†
            const pctElem = document.getElementById('h-pct');
            pctElem.innerText = (m.pct > 0 ? '+' : '') + m.pct + '%';
            pctElem.style.color = m.pct >= 0 ? 'var(--danger)' : 'var(--success)'; 
            
            document.getElementById('h-rsi').innerText = m.tech.RSI;
            
            // RSI é¡è‰²è­¦ç¤º
            const rsiVal = parseFloat(m.tech.RSI);
            const rsiElem = document.getElementById('h-rsi');
            if(rsiVal > 70) rsiElem.style.color = 'var(--danger)';
            else if(rsiVal < 30) rsiElem.style.color = 'var(--success)';
            else rsiElem.style.color = 'var(--text-main)';

            document.getElementById('h-trend').innerText = m.tech.Trend;
            document.getElementById('hud').style.display = 'grid';

            if(data.chartData && typeof Chart !== 'undefined') {
                renderChart(data.chartData.dates, data.chartData.prices);
                document.getElementById('chartBox').style.display = 'block';
            }
        }

        document.getElementById('md-content').innerHTML = data.content;
        document.getElementById('rawText').value = data.raw;
        document.getElementById('reportBox').style.display = 'block';

    } catch(e) {
        alert("System Error: " + e);
        console.error(e);
        document.getElementById('loader').style.display = 'none';
    }
}

function renderChart(dates, prices) {
    const ctx = document.getElementById('priceChart').getContext('2d');
    if(myChart) myChart.destroy();
    
    let gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(37, 99, 235, 0.2)'); 
    gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');

    myChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Price',
                data: prices,
                borderColor: '#2563eb',
                backgroundColor: gradient,
                borderWidth: 2,
                pointRadius: window.innerWidth < 768 ? 2 : 3, // æ‰‹æ©Ÿç‰ˆç¸®å°åœ“é»
                pointBackgroundColor: '#ffffff',
                pointBorderColor: '#2563eb',
                fill: true,
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index',
            },
            plugins: { 
                legend: { display: false },
                tooltip: {
                    backgroundColor: '#1e293b',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    padding: 10,
                    cornerRadius: 6,
                    displayColors: false
                }
            },
            scales: {
                x: { 
                    grid: { display: false }, 
                    ticks: { 
                        color: '#64748b', 
                        font: {family: 'Inter'},
                        maxTicksLimit: window.innerWidth < 768 ? 5 : 10 // æ‰‹æ©Ÿç‰ˆæ¸›å°‘Xè»¸æ¨™ç±¤
                    } 
                },
                y: { 
                    grid: { color: '#f1f5f9', borderDash: [5, 5] }, 
                    ticks: { color: '#64748b', font: {family: 'Inter'} },
                    beginAtZero: false 
                }
            }
        }
    });
}

async function runExplain() {
    const txt = document.getElementById('rawText').value;
    if(!txt) return alert("è«‹å…ˆç”Ÿæˆå ±å‘Šæ‰èƒ½é€²è¡Œç¿»è­¯ / Please generate report first");
    
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('explainText').innerText = "AI æ­£åœ¨åˆ†ææ•¸æ“š... / AI is analyzing data...";
    
    try {
        const res = await fetch('/explain_simple', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: txt})
        });
        const data = await res.json();
        document.getElementById('explainText').innerText = data.explanation;
    } catch(e) {
        document.getElementById('explainText').innerText = "ç¿»è­¯é€£ç·šé€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚ / Connection timeout, please try again.";
    }
}

function copyRaw() {
    const txt = document.getElementById('rawText');
    txt.style.display = 'block';
    txt.select();
    document.execCommand('copy');
    txt.style.display = 'none';
    
    const btn = document.querySelector('.copy-btn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-check"></i> å·²è¤‡è£½ Copied!';
    setTimeout(() => {
        btn.innerHTML = originalText;
    }, 2000);
}
</script>

</body>
</html>
