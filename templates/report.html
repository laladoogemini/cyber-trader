<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æŠ•è³‡æˆ°æƒ…å®¤</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #0f172a; --bg-panel: #1e293b; --border: #334155;
            --primary: #38bdf8; --text-main: #f8fafc; --text-sub: #94a3b8;
            --up: #ef4444; --down: #10b981; --gold: #f59e0b;
        }
        body { margin: 0; font-family: "Microsoft JhengHei", -apple-system, sans-serif; background: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; z-index: 20; flex-shrink: 0; }
        .main-area { flex: 1; display: flex; flex-direction: column; min-width: 0; position: relative; }
        .right-sidebar { width: 220px; background: var(--bg-panel); border-left: 1px solid var(--border); padding: 20px; flex-shrink: 0; overflow-y: auto; display: flex; flex-direction: column; }
        .logo { font-size: 20px; font-weight: 700; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .section-label { font-size: 11px; color: var(--text-sub); font-weight: 600; margin-bottom: 10px; letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; margin-top: 20px; }
        input, select, .btn { width: 100%; padding: 10px; margin-bottom: 10px; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .btn-primary { background: var(--primary); color: #0f172a; font-weight: 700; border: none; cursor: pointer; transition: 0.2s; }
        .btn-primary:hover { background: #7dd3fc; }
        .btn-outline { background: transparent; color: var(--text-sub); border: 1px solid var(--border); cursor: pointer; text-align: left; transition: 0.2s; }
        .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); background: rgba(255,255,255,0.05); }
        .news-box { flex: 1; overflow-y: auto; margin-top: 10px; padding-right: 5px; min-height: 150px; }
        .news-item { display: block; padding: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.03); border-radius: 6px; text-decoration: none; border-left: 3px solid transparent; transition: 0.2s; }
        .news-item:hover { background: rgba(255,255,255,0.06); border-left-color: var(--primary); }
        .news-title { font-size: 12px; color: var(--text-main); line-height: 1.4; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .news-meta { font-size: 10px; color: var(--text-sub); display: flex; justify-content: space-between; }
        .clock-container { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); text-align: left; }
        .clock-time { font-size: 28px; font-weight: 700; color: var(--text-main); line-height: 1; }
        .clock-date { font-size: 13px; color: var(--text-sub); margin-top: 5px; }
        .top-bar { height: 50px; border-bottom: 1px solid var(--border); background: var(--bg-panel); display: flex; align-items: center; padding: 0 20px; }
        .status { font-size: 12px; color: var(--text-sub); display: flex; align-items: center; gap: 8px; }
        .dot { width: 6px; height: 6px; background: #10b981; border-radius: 50%; box-shadow: 0 0 6px #10b981; }
        .dashboard-content { flex: 1; overflow: hidden; padding: 20px; display: flex; flex-direction: column; }
        .hud { display: none; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; flex-shrink: 0; }
        .hud-card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; }
        .hud-title { font-size: 11px; color: var(--text-sub); margin-bottom: 4px; }
        .hud-val { font-size: 22px; font-weight: 700; color: var(--text-main); }
        .pos { color: var(--up); } .neg { color: var(--down); }
        .split-view { display: none; flex: 1; gap: 20px; min-height: 0; }
        .left-column { flex: 5; display: flex; flex-direction: column; gap: 15px; min-width: 0; }
        .price-chart-box { flex: 55; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; position: relative; }
        .indicator-chart-box { flex: 45; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 15px; position: relative; }
        .report-container { flex: 4; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; padding: 25px; overflow-y: auto; position: relative; display: flex; flex-direction: column; }
        .report-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .model-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; background: rgba(56, 189, 248, 0.1); border: 1px solid var(--primary); color: var(--primary); font-size: 11px; }
        .report-actions { display: flex; gap: 10px; }
        .action-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: var(--text-sub); padding: 4px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .action-btn:hover { background: rgba(255,255,255,0.1); color: var(--text-main); border-color: var(--text-main); }
        .report-header h2 { font-size: 20px; margin: 10px 0 5px 0; color: var(--text-main); }
        .report-meta { color: var(--gold); font-size: 12px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .md-body { line-height: 1.7; color: #cbd5e1; font-size: 14px; flex: 1; }
        .md-body h3 { color: var(--primary); margin-top: 20px; font-size: 16px; border-left: 3px solid var(--primary); padding-left: 10px; }
        .md-body strong { color: var(--gold); }
        .md-body blockquote { border-left: 4px solid var(--primary); background: rgba(56,189,248,0.1); margin: 10px 0; padding: 10px; color: #e2e8f0; }
        .md-body table { width: 100%; border-collapse: separate; border-spacing: 0; margin: 15px 0; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .md-body th { background: rgba(255,255,255,0.08); text-align: left; padding: 10px; font-size: 13px; color: var(--text-main); border-bottom: 1px solid var(--border); }
        .md-body td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; color: var(--text-sub); }
        .index-card { background: rgba(255,255,255,0.03); border-radius: 6px; padding: 12px; margin-bottom: 10px; }
        .index-name { font-size: 12px; color: var(--text-sub); margin-bottom: 4px; }
        .index-price { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .index-change { font-size: 13px; float: right; }
        .loader { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(15,23,42,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 50; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border); padding: 24px; width: 90%; max-width: 500px; border-radius: 12px; }
        /* FAB for Advisor */
        .fab {
  position: fixed;
  right: 24px;
  bottom: 24px;
  z-index: 120;
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: #38bdf8;
  color: #0f172a;
  border: none;
  cursor: pointer;
  box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  font-size: 28px;     /* åœ–ç¤ºå¤§å° */
  line-height: 64px;   /* è®“åœ–ç¤ºå‚ç›´ç½®ä¸­ */
  text-align: center;
}
.fab:hover { background: #7dd3fc; }
        .modal-title { color: var(--primary); margin-top: 0; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo"><i class="fa-solid fa-chart-line"></i> AI æŠ•è³‡æ¿€æƒ…å†°æœå®¤</div>

        <div class="section-label">MACRO STRATEGY</div>
        <button class="btn btn-outline" onclick="run('WEEKLY')">
            <i class="fa-solid fa-globe"></i> å…¨çƒå¸‚å ´é€±å ±
        </button>

        <div class="section-label">STOCK ANALYSIS</div>
        <select id="sel" onchange="document.getElementById('inp').value=this.value">
            <option value="" disabled selected>å¿«é€Ÿé¸æ“‡ç†±é–€æ¨™çš„</option>
            <optgroup label="ğŸ”¥ å°è‚¡æ¬Šå€¼">
                <option value="2330">2330 å°ç©é›»</option>
                <option value="2317">2317 é´»æµ·</option>
                <option value="2454">2454 è¯ç™¼ç§‘</option>
                <option value="0050">0050 å°ç£50</option>
            </optgroup>
            <optgroup label="ğŸª™ åŠ å¯†è²¨å¹£">
                <option value="BTC">BTC æ¯”ç‰¹å¹£</option>
                <option value="ETH">ETH ä»¥å¤ªå¹£</option>
                <option value="SOL">SOL Solana</option>
                <option value="ADA">ADA Cardano</option>
                <option value="BNB">BNB å¹£å®‰å¹£</option>
            </optgroup>
            <optgroup label="ğŸ‡ºğŸ‡¸ ç¾è‚¡">
                <option value="NVDA">NVDA NVIDIA</option>
                <option value="TSLA">TSLA Tesla</option>
            </optgroup>
        </select>
        <input type="text" id="inp" placeholder="è¼¸å…¥ä»£è™Ÿ...">
        <button class="btn btn-primary" onclick="run('STOCK')">
            <i class="fa-solid fa-bolt"></i> é–‹å§‹æ·±åº¦åˆ†æ
        </button>

        <div class="section-label">REAL-TIME NEWS</div>
        <div class="news-box" id="news-feed">
            <div style="text-align:center; color: var(--text-sub); font-size: 13px; padding-top:20px;">è«‹é¸æ“‡æ¨™çš„...</div>
        </div>

        <div class="clock-container">
            <div class="clock-time" id="clock-time">--:--</div>
            <div class="clock-date" id="clock-date">----/--/--</div>
        </div>
    </div>

    <div class="main-area">
        <div class="top-bar">
            <div class="status"><div class="dot"></div> System Online</div>
        </div>

        <div class="dashboard-content">
            <div id="welcome" style="text-align: center; padding-top: 100px; color: var(--text-sub);">
                <i class="fa-solid fa-robot" style="font-size: 60px; margin-bottom: 20px; opacity: 0.5;"></i>
                <h2 style="color: var(--text-main);">AI Dual-Model System</h2>
                <p>è«‹å¾å·¦å´é¸æ“‡æ¨™çš„ï¼Œå³å´å°‡é¡¯ç¤ºå³æ™‚æŒ‡æ•¸</p>
            </div>

            <div id="loader" class="loader">
                <div class="spinner"></div>
                <div style="font-size: 18px; font-weight: 500;">AI Reasoning in Progress...</div>
                <div id="statusText" style="color: var(--primary); font-size: 14px; margin-top: 10px;">Connecting...</div>
            </div>

            <div id="hud" class="hud">
                <div class="hud-card"><div class="hud-title">Price ç¾åƒ¹</div><div id="h-price" class="hud-val">--</div></div>
                <div class="hud-card"><div class="hud-title">Change æ¼²è·Œ</div><div id="h-pct" class="hud-val">--</div></div>
                <div class="hud-card"><div class="hud-title">RSI å¼·å¼±</div><div id="h-rsi" class="hud-val">--</div></div>
                <div class="hud-card"><div class="hud-title">Trend è¶¨å‹¢</div><div id="h-trend" class="hud-val" style="font-size: 20px;">--</div></div>
            </div>

            <div id="splitBox" class="split-view">
                <div class="left-column">
                    <div class="price-chart-box">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="indicator-chart-box">
                        <canvas id="indicatorChart"></canvas>
                    </div>
                </div>

                <div class="report-container">
                    <div class="report-header-row">
                        <div id="badge-area"></div>
                        <div class="report-actions">
                            <button class="action-btn" onclick="runExplain()"><i class="fa-regular fa-comment-dots"></i> ç™½è©±ç¿»è­¯</button>
                            <button class="action-btn" onclick="copyRaw()"><i class="fa-regular fa-copy"></i> è¤‡è£½åŸæ–‡</button>
                        </div>
                    </div>
                    <div id="report-title-area"></div>
                    <div id="report-content" class="md-body"></div>
                    <textarea id="rawText" style="display:none;"></textarea>
                    <div style="margin-top:16px; font-size:12px; color:#94a3b8; border-top:1px solid rgba(255,255,255,0.08); padding-top:12px;">
                      å…è²¬è²æ˜ï¼šæœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒï¼Œä¸¦éæŠ•è³‡å»ºè­°ã€‚å¸‚å ´æœ‰é¢¨éšªï¼ŒæŠ•è³‡éœ€è¬¹æ…ã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="right-sidebar">
        <div class="section-label" style="margin-top:0;">GLOBAL INDICES</div>
        <div id="indices-box"></div>
        <div id="indices-updated" style="color: var(--text-sub); font-size: 11px; margin-top: 6px;"></div>
    </div>

    <!-- å³ä¸‹è§’ FABï¼šAI æŠ•é¡§è€å¸«ï¼ˆé›™æ¨¡å‹ï¼‰ -->
    <button class="fab" title="AIæŠ•é¡§è€å¸«ï¼ˆé›™æ¨¡å‹ï¼‰" onclick="openAdvisor()">ğŸ¤–</button>

    <!-- æŠ•é¡§è€å¸«å½ˆçª— -->
    <div id="advisorModal" class="modal" onclick="this.style.display='none'">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 class="modal-title">AI æŠ•é¡§è€å¸«ï¼ˆé›™æ¨¡å‹ç²¾è¯ï¼‰</h3>
            <div id="advisorContent" style="line-height:1.6; color: var(--text-main); white-space: pre-line;">å°šæœªæœ‰å…§å®¹ï¼Œè«‹å…ˆç”Ÿæˆå€‹è‚¡å ±å‘Šã€‚</div>
            <button class="btn btn-primary" style="width:auto; padding:6px 20px; float:right;" onclick="document.getElementById('advisorModal').style.display='none'">é—œé–‰</button>
            <div style="clear:both;"></div>
        </div>
    </div>

    <div id="modal" class="modal" onclick="this.style.display='none'">
        <div class="modal-box" onclick="event.stopPropagation()">
            <h3 style="color: var(--primary); margin-top: 0;">æŠ•è³‡è€æ‰‹ç¿»è­¯</h3>
            <p id="explainText" style="line-height: 1.6; color: var(--text-main); margin: 20px 0;">...</p>
            <button class="btn btn-primary" style="width: auto; padding: 6px 20px; float:right;" onclick="document.getElementById('modal').style.display='none'">é—œé–‰</button>
            <div style="clear:both;"></div>
        </div>
    </div>

    <script>
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-time').innerText = now.toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute:'2-digit'});
            document.getElementById('clock-date').innerText = now.toLocaleDateString('zh-TW', {year: 'numeric', month: '2-digit', day: '2-digit'});
        }
        setInterval(updateClock, 1000); updateClock();

        async function fetchIndices() {
            try {
                const res = await fetch('/get_indices');
                const data = await res.json();
                document.getElementById('indices-box').innerHTML = data.map(i => `
                    <div class="index-card">
                        <div class="index-name">${i.name}</div>
                        <div class="index-price">${i.price}</div>
                        <div class="index-change ${i.change >= 0 ? 'pos' : 'neg'}">${i.change >= 0 ? '+' : ''}${i.change}%</div>
                        <div style="clear:both;"></div>
                    </div>
                `).join('');
                document.getElementById('indices-updated').innerText = 'æ›´æ–°æ™‚é–“ï¼š' + new Date().toLocaleTimeString('zh-TW', {hour12:false});
            } catch {
                document.getElementById('indices-box').innerHTML = '<div style="color:#94a3b8;">æŒ‡æ•¸è¼‰å…¥å¤±æ•—</div>';
            }
        }
        fetchIndices();

        let priceChart = null;
        let indicatorChart = null;

        const commonTooltip = {
          enabled: true,
          callbacks: {
            label: function(ctx) {
              const val = ctx.parsed.y;
              return ' ' + ctx.dataset.label + ': ' + (typeof val === 'number' ? val.toFixed(2) : val);
            }
          },
          backgroundColor: 'rgba(2,6,23,0.9)',
          titleColor: '#e2e8f0',
          bodyColor: '#cbd5e1',
          borderColor: '#334155',
          borderWidth: 1
        };

        async function run(type) {
            let ticker = type === 'WEEKLY' ? 'WEEKLY' : document.getElementById('inp').value.trim();
            if(!ticker) return alert("è«‹è¼¸å…¥ä»£è™Ÿ");

            document.getElementById('welcome').style.display = 'none';
            document.getElementById('hud').style.display = 'none';
            document.getElementById('splitBox').style.display = 'none';
            document.getElementById('loader').style.display = 'flex';

            if(type !== 'WEEKLY') fetchNews(ticker);

            try {
                document.getElementById('statusText').innerText = "Phase 1: DeepSeek R1 Reasoning...";
                const res = await fetch('/get_analysis', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body: JSON.stringify({ticker: ticker})
                });

                document.getElementById('statusText').innerText = "Phase 2: xAI Grok Synthesis...";
                const data = await res.json();
                if(data.error) throw new Error(data.error);

                document.getElementById('loader').style.display = 'none';

                if(data.type === 'stock') {
                    window.__lastMeta = data.meta; // ä¿å­˜å€‹è‚¡è³‡æ–™ä¾› /advise
                    renderHUD(data.meta);
                    renderPriceChart(data.chartData.dates, data.chartData.prices, data.meta.pct >= 0);
                    renderIndicatorChart(data.chartData.dates, data.chartData.volumes, data.chartData.macd, data.chartData.macd_signal, data.chartData.macd_hist);

                    document.getElementById('badge-area').innerHTML =
                      `<div class="model-badge" title="R1: æ·±åº¦æ¨ç†ï¼›Grok: æ–°æ‰‹æŒ‡å¼•æ•´åˆ"><i class="fa-solid fa-microchip"></i> ${data.model_info}</div>`;
                    document.getElementById('report-title-area').innerHTML = `
                        <h2>${data.meta.name_zh} (${data.meta.symbol}) æ“ä½œå»ºè­°å ±å‘Š</h2>
                        <div class="report-meta">æ—¥æœŸ: ${new Date().toISOString().split('T')[0]} | æª¢æ ¸è‚¡åƒ¹: ${data.meta.price} (${data.meta.pct}%)</div>`;
                    document.querySelector('.left-column').style.display = 'flex';
                } else {
                    document.getElementById('badge-area').innerHTML =
                      `<div class="model-badge" title="R1: æ·±åº¦æ¨ç†ï¼›Grok: æ–°æ‰‹æŒ‡å¼•æ•´åˆ"><i class="fa-solid fa-microchip"></i> ${data.model_info}</div>`;
                    document.getElementById('report-title-area').innerHTML =
                      `<h2>å…¨çƒå®è§€å¸‚å ´é€±å ±</h2><div class="report-meta">æ—¥æœŸ: ${new Date().toISOString().split('T')[0]} | é€±æœŸ: æœ¬é€±</div>`;
                    document.querySelector('.left-column').style.display = 'none';
                }

                document.getElementById('report-content').innerHTML = data.content;
                document.getElementById('rawText').value = data.raw;
                document.getElementById('splitBox').style.display = 'flex';

            } catch(e) {
                showError(e.message || 'æœå‹™ç•°å¸¸');
            }
        }

        function showError(msg) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('splitBox').style.display = 'flex';
            const report = document.getElementById('report-content');
            report.innerHTML = `
                <div style="background: rgba(239,68,68,0.12); border:1px solid #ef4444; color:#fecaca; padding:12px; border-radius:8px;">
                    <strong>ç™¼ç”ŸéŒ¯èª¤ï¼š</strong> ${msg}<br>
                    è«‹ç¨å¾Œé‡è©¦ï¼Œæˆ–æ”¹ç”¨å…¶ä»–æ¨™çš„ï¼é€±å ±ã€‚
                </div>
            `;
        }

        async function fetchNews(ticker) {
            const el = document.getElementById('news-feed');
            el.innerHTML = '<div style="text-align:center;">Loading...</div>';
            try {
                const res = await fetch('/get_news', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ticker: ticker}) });
                const data = await res.json();
                if (data.news && data.news.length) {
                  el.innerHTML = data.news.map(n => `
                      <a href="${n.link}" target="_blank" class="news-item">
                          <div class="news-title">${n.title}</div>
                          <div class="news-meta"><span>${n.publisher}</span><span>${n.time}</span></div>
                      </a>`).join('');
                } else {
                  const reason = data.reason || 'no_data';
                  let msg = 'ç›®å‰ç„¡å¯ç”¨æ–°èä¾†æº';
                  if (reason === 'no_source') msg = 'ä¾†æºæš«ç„¡æ–°èï¼ˆyfinance æœªæä¾›ï¼‰ã€‚';
                  if (reason === 'server_error') msg = 'ä¼ºæœå™¨æš«æ™‚ç„¡æ³•å–å¾—æ–°èã€‚';
                  el.innerHTML = `<div style="color:#94a3b8;">${msg}</div>`;
                }
            } catch {
                el.innerHTML = '<div style="color:#94a3b8;">æ–°èè¼‰å…¥å¤±æ•—</div>';
            }
        }

        function renderHUD(meta) {
            document.getElementById('h-price').innerText = meta.price;
            const elPct = document.getElementById('h-pct');
            elPct.innerText = (meta.pct > 0 ? '+' : '') + meta.pct + '%';
            elPct.className = 'hud-val ' + (meta.pct >= 0 ? 'pos' : 'neg');
            document.getElementById('h-rsi').innerText = meta.tech.RSI;
            const elTrend = document.getElementById('h-trend');
            elTrend.innerText = meta.tech.Trend;
            elTrend.style.color = meta.tech.Trend.includes('å¤š') ? '#ef4444' : '#10b981';
            document.getElementById('hud').style.display = 'grid';
        }

        function renderPriceChart(dates, prices, isUp) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            if(priceChart) priceChart.destroy();
            const color = isUp ? '#ef4444' : '#10b981';
            const gradient = ctx.createLinearGradient(0,0,0,300);
            gradient.addColorStop(0, isUp ? 'rgba(239,68,68,0.2)' : 'rgba(16,185,129,0.2)');
            gradient.addColorStop(1, 'rgba(15,23,42,0)');

            priceChart = new Chart(ctx, {
                type: 'line',
                data: { labels: dates, datasets: [{ label: 'Price', data: prices, borderColor: color, backgroundColor: gradient, borderWidth: 2, pointRadius: 0, fill: true }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: {display: false}, tooltip: commonTooltip },
                    scales: { x: {display: false}, y: {grid: {color: '#334155'}} }
                }
            });
        }

        function renderIndicatorChart(dates, vols, macd, signal, hist) {
            const ctx = document.getElementById('indicatorChart').getContext('2d');
            if(indicatorChart) indicatorChart.destroy();

            indicatorChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        { type: 'line', label: 'MACD', data: macd, borderColor: '#38bdf8', borderWidth: 1, pointRadius: 0, yAxisID: 'y' },
                        { type: 'line', label: 'Signal', data: signal, borderColor: '#f59e0b', borderWidth: 1, pointRadius: 0, yAxisID: 'y' },
                        { type: 'bar', label: 'Hist', data: hist, backgroundColor: (ctx) => {
                            const v = ctx.raw; return v >= 0 ? '#ef4444' : '#10b981';
                        }, yAxisID: 'y' },
                        { type: 'bar', label: 'Vol', data: vols, backgroundColor: 'rgba(255,255,255,0.1)', yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: {display: false}, tooltip: commonTooltip },
                    scales: {
                        x: { display: false },
                        y: { position: 'right', grid: {color: '#334155'}, ticks: { color: '#9ca3af' } },
                        y1: { display: false, min: 0 }
                    }
                }
            });
        }

        async function copyRaw() {
          try {
            const txt = document.getElementById('rawText').value || '';
            await navigator.clipboard.writeText(txt);
            alert("å ±å‘Šå…§å®¹å·²è¤‡è£½ï¼");
          } catch {
            const txt = document.getElementById('rawText');
            txt.style.display = 'block'; txt.select(); document.execCommand('copy'); txt.style.display = 'none';
            alert("å·²å˜—è©¦ä»¥ç›¸å®¹æ–¹å¼è¤‡è£½ï¼Œè‹¥å¤±æ•—è«‹æ‰‹å‹•è¤‡è£½ã€‚");
          }
        }

        function runExplain() {
            const content = document.getElementById('rawText').value || '';
            if(!content) return alert("è«‹å…ˆç”Ÿæˆå ±å‘Š");
            document.getElementById('modal').style.display = 'flex';

            const isAggressive = /ç©æ¥µ|ğŸŸ¢|çœ‹å¤š|ä¸Šå½|çªç ´|é‡åƒ¹é½Šå‡/.test(content);
            const isCaution = /é¢¨éšª|å›æª”|ğŸŸ¡|éœ‡ç›ª|åœæ|è§€æœ›/.test(content);
            const isBear = /ğŸ”´|ä¸‹å½|ç ´ç·š|ç©ºé ­|è½‰å¼±/.test(content);

            let line = "ç°¡å–®ä¾†èªªï¼šç›®å‰èµ°å‹¢ä¸­æ€§ï¼Œå…ˆè§€æœ›ç‚ºä¸»ã€‚";
            if (isBear) line = "ç°¡å–®ä¾†èªªï¼šèµ°å‹¢åå¼±ï¼Œé¿å…è¿½é«˜ï¼Œåš´è¨­åœæã€‚";
            else if (isAggressive && !isCaution) line = "ç°¡å–®ä¾†èªªï¼šèµ°å‹¢åå¼·ï¼Œå¯å°‘é‡è·Ÿé€²ã€åˆ†æ‰¹å¸ƒå±€ã€‚";
            else if (isCaution) line = "ç°¡å–®ä¾†èªªï¼šæœ‰æ©Ÿæœƒä½†é¢¨éšªä¸å°ï¼Œåˆ†æ‰¹ã€åš´è¨­åœæï¼Œé¿å…è¿½é«˜ã€‚";

            setTimeout(() => {
                document.getElementById('explainText').innerText = `${line}\n(é€™æ˜¯åŸºæ–¼ AI å ±å‘Šçš„å¿«é€Ÿç¸½çµ)`;
            }, 300);
        }

        // å³ä¸‹è§’ï¼šAI æŠ•é¡§è€å¸«
        async function openAdvisor() {
          const raw = document.getElementById('rawText').value || '';
          const title = document.getElementById('report-title-area').innerText || '';
          if (!raw || title.includes('é€±å ±')) {
            alert('è«‹å…ˆç”Ÿæˆã€Œå€‹è‚¡ã€å ±å‘Šï¼Œå†ä½¿ç”¨ AI æŠ•é¡§è€å¸«ã€‚');
            return;
          }
          const meta = window.__lastMeta || null;
          if (!meta) { alert('ç¼ºå°‘å€‹è‚¡è³‡è¨Šï¼Œè«‹é‡æ–°ç”¢ç”Ÿå ±å‘Šã€‚'); return; }

          document.getElementById('advisorModal').style.display = 'flex';
          const box = document.getElementById('advisorContent');
          box.innerText = 'AI æ€è€ƒä¸­...';

          try {
            const r = await fetch('/advise', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({meta, raw})
            });
            const d = await r.json();
            if (d.error) throw new Error(d.error);
            const simple = (d.advice_simple || '').trim();
            const rawAdvice = (d.advice_raw || '').trim();
            box.innerText = `é‡é»å»ºè­°ï¼ˆç²¾ç°¡ï¼‰ï¼š\n${simple}\n\nå°ˆæ¥­è¦é»ï¼š\n${rawAdvice}`;
          } catch (e) {
            box.innerText = 'æš«æ™‚ç„¡æ³•å–å¾—å»ºè­°ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
          }
        }
    </script>
</body>
</html>
